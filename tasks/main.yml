---
- name: Ensure Elasticsearch operator namespace exists
  kubernetes.core.k8s:
    state: present
    api_version: v1
    kind: Namespace
    name: "{{ elasticsearch_operator_namespace }}"

- name: Ensure Elasticsearch instance namespace exists
  kubernetes.core.k8s:
    state: present
    api_version: v1
    kind: Namespace
    name: "{{ elasticsearch_namespace }}"

# ----------------------------------------------------
# Install Elasticsearch ECK Operator from OperatorHub
# ----------------------------------------------------
- name: Subscribe to Elasticsearch ECK operator
  kubernetes.core.k8s:
    state: present
    kind: Subscription
    api_version: operators.coreos.com/v1alpha1
    namespace: "{{ elasticsearch_operator_namespace }}"
    name: elasticsearch-eck-operator
    definition:
      spec:
        channel: stable
        name: elasticsearch-eck-operator-certified
        source: certified-operators
        sourceNamespace: openshift-marketplace
        installPlanApproval: Automatic

- name: Wait for Elasticsearch ECK Operator to become available
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    namespace: "{{ elasticsearch_operator_namespace }}"
    name: elastic-operator
  register: operator_deploy
  until: operator_deploy.resources | length > 0 and operator_deploy.resources[0].status.availableReplicas|default(0) > 0
  retries: 30
  delay: 10

# ----------------------------------------------------
# Create Elasticsearch instance using ECK
# ----------------------------------------------------
- name: Deploy Elasticsearch instance
  kubernetes.core.k8s:
    state: present
    namespace: "{{ elasticsearch_namespace }}"
    definition:
      apiVersion: elasticsearch.k8s.elastic.co/v1
      kind: Elasticsearch
      metadata:
        name: "{{ elasticsearch_instance_name }}"
      spec:
        version: "{{ elasticsearch_version }}"
        nodeSets:
          - name: default
            count: "{{ elasticsearch_node_count }}"
            config:
              node.roles: ["master", "data"]
              node.store.allow_mmap: false
            podTemplate:
              spec:
                containers:
                  - name: elasticsearch
                    resources:
                      requests:
                        memory: "{{ elasticsearch_memory_request }}"
                        cpu: "{{ elasticsearch_cpu_request }}"
                      limits:
                        memory: "{{ elasticsearch_memory_limit }}"
                        cpu: "{{ elasticsearch_cpu_limit }}"
                    volumeMounts:
                      - name: elasticsearch-data
                        mountPath: /usr/share/elasticsearch/data
                volumes:
                  - name: elasticsearch-data
                    emptyDir: {}

- name: Wait for Elasticsearch cluster to be ready
  kubernetes.core.k8s_info:
    api_version: elasticsearch.k8s.elastic.co/v1
    kind: Elasticsearch
    namespace: "{{ elasticsearch_namespace }}"
    name: "{{ elasticsearch_instance_name }}"
  register: es_cluster
  until: es_cluster.resources | length > 0 and es_cluster.resources[0].status.phase|default('') == 'Ready'
  retries: 40
  delay: 15

- name: Wait for Elasticsearch pods to be ready
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ elasticsearch_namespace }}"
    label_selectors:
      - elasticsearch.k8s.elastic.co/cluster-name={{ elasticsearch_instance_name }}
  register: es_pods
  until: es_pods.resources | length > 0 and (es_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length) == (es_pods.resources | length)
  retries: 40
  delay: 15